# Polygon zkEVM

# 简介

Polygon zkEVM是一种去中心化的以太坊2层可扩展性解决方案，它使用加密零知识证明为链下交易计算（也称为ZK-Rollup）提供有效性和快速最终性。ZK-Rollup 通过发布零知识有效性证明透明地执行智能合约，同时保持与以太坊虚拟机的操作码兼容性。

## 使用zkEVM扩展以太坊

鉴于以太坊受制于区块链三角难题，它无法在不牺牲去中心化或安全性的情况下扩展到超过其交易门槛。这就是 Polygon zkEVM 发挥作用的地方。

Polygon zkEVM，是一种虚拟机，旨在通过重新创建所有现有的EVM操作码来模拟以太坊虚拟机 (EVM) ，以透明部署现有的以太坊智能合约。Polygon zkEVM开发了零知识汇总 (ZK-Rollups)，它运行在以太坊主网上，并以指数方式提高以太坊的可扩展性和每秒交易量 (TPS)。

为了证明链下计算的正确性，Polygon zkEVM采用可验证的零知识证明作为有效性证明。尽管2层零知识证明基于复杂的多项式计算来为链下交易提供验证和最终性，但有效性证明快速且易于验证。

作为状态机，zkEVM 执行状态更改，这些更改来自用户发送到网络的以太坊2层交易的执行，并随后生成有效性证明，证明链下执行的状态更改的计算的正确性。

尽管采用这种革命性的设计方法是一个艰难的决定，但目标是尽量减少用户和开发人员在使用该解决方案时的摩擦。这是一种需要重新创建所有 EVM 操作码以透明部署现有以太坊智能合约的方法。为此，团队创建并设计了一套新的技术和工具。

## Polygon zkEVM的优势

* EVM等效
* 以太坊安全
* ZKP 支持的可扩展性

Polygon zkEVM是以太坊的2层扩展解决方案，利用零知识证明的扩展能力，同时保持以太坊兼容性。Polygon zkEVM上的开发人员和用户可以使用他们在以太坊上使用的相同代码、工具、应用程序等，但具有更高的吞吐量和更低的费用。

开发人员将他们现有的合约部署到zkEVM，用户可以从以太坊存入资产并进行链下交易。这些交易被分成批次，零知识证明证明每笔交易的有效性。这保证了zkEVM的运营者无法窃取用户资金，可以说它继承了以太坊的安全性。

# 架构

Polygon zkEVM处理由以太坊第2层交易执行（用户发送到网络的交易）引起的状态转换。然后zkEVM创建有效性证明，利用零知识特性证明这些链下状态变化计算的准确性。

Polygon zkEVM 的骨架架构如下图所示：

![Polygon zkEVM Architecture](./assets/01001_polygon_zkevm_arch.png)

## zkEVM 的主要组件

* 共识合约 (PolygonZkEVM.sol)
* zkNode
  * 同步器
  * 定序器和聚合器
  * RPC
* zkProver
* zkEVM Bridge

### 共识合约

早期版本Polygon Hermez 1.0基于捐赠证明(PoD)共识机制。PoD基本上是一种自动进行的去中心化拍卖，参与者（协调者）出价一定数量的代币，以便被选中创建下一批。

最新的共识合约(PolygonZkEVM.sol)在v1.0中利用了现有PoD的经验，并添加了对多个协调器的无许可参与以在L2中生产批次的支持。

早期的捐赠证明（PoD）机制是基于去中心化的拍卖模型来获得在特定时间范围内生产批次的权利。在这种机制中，建立了经济激励机制，因此验证者需要非常高效才能具有竞争力。

最新版本的zkEVM共识合约（部署在第1层）以[效率证明(PoE)](https://ethresear.ch/t/proof-of-efficiency-a-new-consensus-mechanism-for-zk-rollups/11988)为模型。它利用了v1.0中现有PoD的经验，并增加了对多个协调器的无许可参与以在 L2 中生产批次的支持。

#### 实施模式

共识合约模型利用现有的PoD机制，支持多个协调者的无许可参与，在L2中生产批次。这些批次是根据L1的汇总交易创建的。共识合约(PolygonZkEVM.sol)采用了一种更简单的技术，并且由于其在解决 PoD 中涉及的挑战方面效率更高而受到青睐。

基于合约共识的战略实施承诺确保网络：

* 保持其无许可功能以生成L2批次
* 高效，这是衡量整体网络性能的关键标准
* 达到可接受的权力下放程度
* 免受恶意攻击，尤其是来自验证者的攻击
* 在整体验证工作和网络价值之间保持公平的平衡

#### 链上数据可用性

完整的ZK-Rollup模式需要在链上发布数据（用户需要重建完整状态）和有效性证明（零知识证明）。然而，考虑到以太坊配置，在链上发布数据会产生gas价格，这是Layer 1的一个问题。这使得在Full ZK-Rollup配置和混合配置之间做出决定变得具有挑战性。

在混合模式下，以下任一情况都是可能的：

* Validium：数据存储在链下，只有有效性证明在链上发布。
* Volition：对于某些交易，数据和有效性证明都保留在链上，而对于其余交易，只有证明在链上。

除非，除其他事项外，可以高度加速证明模块以降低验证器的成本，否则混合模式仍然可行。

#### PolygonZkEVM.sol

zkEVM中的底层协议通过使用有效性证明来确保状态转换是正确的。为了确保遵循一组允许状态转换的预定规则，使用了共识合约（PolygonZkEVM.sol，部署在L1上）。

智能合约验证有效性证明，以确保每个转换都正确完成。这是通过使用zk-SNARK电路来实现的。这种类型的系统需要两个过程：事务批处理和事务验证。

为了执行这些程序，zkEVM使用两种类型的参与者：**定序器**和**聚合器**。在这个两层模型下：
* 定序器：向网络提出交易批次，即他们批量汇总交易请求并将它们添加到共识合约中。
* 聚合器：检查交易批次的有效性并提供有效性证明。任何无许可的聚合器都可以提交证明来证明状态转换计算的正确性。
因此，智能合约进行两次调用：一次是从定序器接收批次，另一次是从聚合器接收批次，请求验证批次。

![PoE](assets/01002_polygon_poe.png)

#### 代币经济学

共识智能合约对定序器和聚合器提出了以下要求：

##### 定序器

* 任何拥有运行zkEVM节点所需软件的人都可以成为定序器。
* 每个定序器都必须以 MATIC 代币的形式支付费用，才能获得创建和提议批次的权利。
* 提议有效批次（由有效交易组成）的定序器受到交易请求者或网络用户支付的费用的激励。​

##### 聚合器

聚合器从定序器接收所有交易信息，并将其发送给Prover，Prover在复杂的多项式计算后提供一个小的zk-Proof。智能合约验证此证明。这样，聚合器收集数据，将其发送给证明者，接收其输出，最后将信息发送给智能合约，以检查证明者的有效性证明是否正确。

* 聚合器的任务是为定序器提出的L2交易提供有效性证明。
* 除了运行zkEVM的zkNode软件外，聚合器还需要专门的硬件来使用zkProver创建零知识有效性证明。
* 对于给定的一个或多个批次，提交有效性证明的聚合器首先赚取 MATIC 费用（由批次的定序者支付）。
* 聚合器需要表明他们验证交易的意图。之后，他们根据自己的策略竞争产生有效性证明。

### zkNode

zkNode是运行任何zkEVM节点所需的软件。网络需要一个客户端来实现同步并管理参与者（定序器或聚合器）的角色。Polygon zkEVM参与者将选择他们的参与方式：

* 作为知道网络状态的节点
* 作为批次生产过程中的任何两个角色的参与者: 定序器或聚合器

zkNode架构本质上是模块化的。

#### 激励构成

zkEVM网络的两个无需许可的参与者是：定序器和聚合器。已经设计了适当的激励结构来保持zkEVM网络的快速和安全。以下是排序器和聚合器的费用构成摘要：

* 定序器
  * 收集交易并批量发布
  * 从已发布的交易中收取费用
  * 支付L1交易费用 + MATIC（取决于待处理的批次）
  * MATIC 进入聚合器
  * 盈利的条件：**txs费用** > **L1调用费用** + **MATIC费用**

* 聚合器
  * 处理定序器发布的交易
  * 构建zk证明
  * 接收来自定序器的MATIC
  * 静态成本：L1调用成本 + 服务器成本（构建证明）
  * 盈利的条件：**MATIC费用** > **L1调用费用** + **服务器成本**

### zkProver

zkEVM采用先进的零知识技术来创建有效性证明。它使用零知识证明器(zkProver)，旨在在任何服务器上运行，并被设计为与大多数消费类硬件兼容。每个聚合器都将使用此zkProver来验证批次并提供有效性证明。
它由一个主状态机执行器、一组辅助状态机（每个都有自己的执行器）、一个STARK证明构建器和一个SNARK证明构建器组成。
简而言之，zkEVM以多项式形式表示状态变化。因此，每个提议的批处理必须满足的约束是多项式约束或多项式恒等式。换句话说，所有有效的批次都必须满足特定的多项式约束。

### zkEVM Bridge

zkEVM桥是一个智能合约，允许用户在LX和LY两层之间转移他们的资产。zkEVM中的L1-L2是用于安全存取资产的去中心化桥梁。它是两个智能合约的组合，一个部署在一个链上，另一个部署在另一条链上。

zkEVM中的L1和L2合约除了各自的部署位置外是相同的。L1桥合约在以太坊主网上，以管理rollup之间的资产转移，而L2桥合约在特定的rollup上，负责主网和Rollup（或多个Rollup）之间的资产转移。

2层互操作性允许使用本机机制在不同的L2网络之间迁移资产。该解决方案嵌入在桥梁智能合约中。

### 验证者

验证者是一个智能合约，能够验证任何ZK-SNARK密码证明。这个SNARK验证器证明批次中每笔交易的有效性。它是任何zk-Rollup架构中的关键实体，主要原因是它验证证明的正确性以确保有效的状态转换。

测试网上验证者合约：**https://goerli.etherscan.io/address/0x8EdA1d8c254a77a57A6A7A1C0262e9A44A7C6D6d#code**

### Transaction Life Cycle
在进入L2交易流程之前，用户需要一些资金来执行任何L2交易。为此，用户需要通过zkEVM Bridge dApp将一些以太币从L1转移到L2。

* 桥
  * 存入以太币
  * 等到**globalExitRoot**在L2上发布
  * 在L2进行认领并收到资金
* L2交易
  * 用户在钱包（例如 Metamask）中发起tx并将其发送到定序器
  * 一旦定序器承诺添加他的交易，就会在L2上完成
  * 交易在L2上已经完成，但在L1上还没有完成（简单地说，L2状态还没有在L1上）。也称为可信状态。
  * 定序器将批次数据发送到L1智能合约，使任何节点能够以无需信任的方式（也称为虚拟状态）从L1同步
  * 聚合器将对未决交易进行验证并构建证明以实现L1的最终性
  * 一旦证明得到验证，用户的交易将达到L1最终确定性（对于提款很重要）。这称为合并状态。

上述过程是zkEVM中交易处理方式的概括。

### 设计特点

计划创建一个网络：无需许可、去中心化、安全、高效，并带有可验证的区块数据。

开发工作旨在实现无许可，即允许任何拥有zkEVM软件的人参与网络。例如，共识算法将让每个人都有机会成为定序器或者聚合器

数据可用性对于去中心化至关重要，因为每个用户都有足够的数据来重建汇总的完整状态。如上所述，团队仍然必须决定数据可用性的最佳配置。目的是确保没有审查制度，任何一方都无法控制网络。

zkEVM在设计时就考虑到了安全性。而作为L2解决方案，大部分安全性都继承自以太坊。智能合约将确保执行状态更改的每个人都适当地执行此操作，创建证明状态更改有效性的证明，并在链上提供有效性证明以供验证。

### 效率与整体策略

效率是网络性能的关键。zkEVM采用多种实现策略来保证效率。下面列出了其中的一些：

1. 第一个策略是部署共识合约，它激励最高效的聚合器参与证明生成过程。

2. 第二种策略是在链下执行所有计算，同时只在链上保留必要的数据和zk-proofs。

3. 桥智能合约的实现方式，比如以UTXO方式结算，仅使用 Exit Tree Roots。

4. 在zkProver中使用专门的加密原语以加速计算并最小化证明大小，如下所示：
  * 运行特殊的零知识汇编语言(zkASM)来解释字节码
  * 使用zk-STARKs等零知识工具进行证明；这些证明虽然规模更大，但速度非常快。
  * zk-SNARK不是发布可观的zk-STARK证明作为有效性证明，而是用于证明zk-STARK证明的正确性。反过来，这些zk-SNARK作为状态更改的有效性证明发布。这有助于将 gas 成本从 5M 降低到 350K。
